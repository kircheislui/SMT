{# roles/ssl_cert_renewal/templates/renewal_report.j2 #}
=====================================
SSL Certificate Renewal Report
=====================================
Status: {{ renewal_status | default('SUCCESS') }}
Date: {{ ansible_date_time.iso8601 }}
Hostname: {{ ansible_hostname }}
FQDN: {{ ansible_fqdn }}
Domain: {{ domain_name }}
Web Application: {{ web_application_type }}
Service: {{ app_service }}

Certificate Details:
  Subject: {{ cert_subject | default(new_cert_info.subject.commonName) }}
  Issuer: {{ cert_issuer | default(new_cert_info.issuer.commonName) }}
  Valid From: {{ new_cert_info.not_before }}
  Valid Until: {{ cert_expiry_date | default(new_cert_info.not_after) }}
  Serial Number: {{ new_cert_info.serial_number }}
  {% if new_cert_info.subject_alt_name is defined %}
  Subject Alt Names:
  {% for san in new_cert_info.subject_alt_name %}
    - {{ san }}
  {% endfor %}
  {% endif %}

Backup Information:
  {% if backup_created | default(false) %}
  Certificate Backup: {{ backup_cert_path }}
  Key Backup: {{ backup_key_path }}
  Metadata: {{ backup_dir }}/backup_metadata_{{ backup_timestamp }}.txt
  {% else %}
  No previous certificate found - first installation
  {% endif %}

Service Information:
  Service Stopped At: {{ service_stopped_at | default('N/A') }}
  Certificate Replaced At: {{ cert_replaced_at | default('N/A') }}
  Service Started At: {{ service_started_at | default('N/A') }}
  {% if service_downtime_seconds is defined %}
  Total Downtime: {{ service_downtime_seconds }} seconds
  {% endif %}
  Final Service State: {{ final_service_status.status.ActiveState | default('N/A') }}

Validation Results:
  Domain Validation: PASSED
  Expiry Validation: PASSED
  Key Match Validation: PASSED
  Configuration Test: {{ 'PASSED' if config_test_result is success else 'N/A' }}

Health Check Results:
  {% if http_health_check is defined %}
  HTTP Status: {{ http_health_check.status | default('N/A') }}
  Response Time: {{ http_health_check.elapsed | default('N/A') }} seconds
  {% endif %}
  Certificate Deployed: {{ 'YES' if health_check_passed | default(false) else 'PENDING' }}
  Service Running: {{ 'YES' if final_service_status.status.ActiveState == 'active' else 'NO' }}

{% if rollback_performed | default(false) %}
ROLLBACK INFORMATION:
  Rollback Performed: YES
  Reason: {{ ansible_failed_result.msg | default('Unknown error') }}
  Original certificates restored
  Service Status: {{ final_rollback_status.status.ActiveState | default('N/A') }}
{% endif %}

=====================================
Generated by Ansible SSL Cert Renewal Role
=====================================